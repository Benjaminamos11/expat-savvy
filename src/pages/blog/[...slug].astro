---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';
import { convertToSocialImage } from '../../utils/imageUtils.js';

// For SSR mode, we need to get the post dynamically
const slug = Astro.params.slug;
let post: CollectionEntry<'blog'> | undefined;
let socialImage = '';

if (slug) {
  const posts = await getCollection('blog');
  post = posts.find((p) => p.slug === slug);
  
  if (post) {
    // Process image for social media if it exists
    socialImage = post.data.image ? convertToSocialImage(post.data.image) : '';
  }
}

// If no post found, return 404
if (!post) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found'
  });
}

// Render the content
let Content;
if (post && typeof post.render === 'function') {
  try {
    const rendered = await post.render();
    Content = rendered.Content;
  } catch (error) {
    console.error('Error rendering post:', error);
    Content = null;
  }
}

// Prepare frontmatter with social image
const frontmatter = {
  ...post.data,
  socialImage: socialImage || post.data.image
};
---

<BlogLayout frontmatter={frontmatter}>
  <Content />
</BlogLayout> 