---
// Remove individual font imports and use Google Fonts instead (loaded in global.css)
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import VAG45Modal from '../components/VAG45Modal.astro';
import PrivacyPolicyModal from '../components/PrivacyPolicyModal.astro';
import TermsOfServiceModal from '../components/TermsOfServiceModal.astro';
import SocialMediaImage from '../components/SocialMediaImage.astro';

// Analytics Components - Consent Mode v2 compliant (loaded at end of body for performance)
import GoogleTag from '../components/analytics/GoogleTag.astro';
import FacebookPixel from '../components/analytics/FacebookPixel.astro';
import CookieBanner from '../components/analytics/CookieBanner.astro';

interface Props {
  title: string;
  description: string;
  type?: string;
  image?: string;
  canonicalURLProp?: string | null;
}

const { 
  title, 
  description, 
  type = "website",
  image = "https://res.cloudinary.com/dphbnwjtx/image/upload/v1746960418/a-photograph-depicts-a-pair-of-youthful-_quYJOYFeRPqWWfrG0MYelw_ndQb4IxjRbGazkFfjfLXNA_qk6hxm.webp",
  canonicalURLProp = null
} = Astro.props;

// Ensure canonical URL is absolute and standardized
let canonicalPath = Astro.url.pathname;

// Standardize path by removing trailing slash first (except for homepage)
if (canonicalPath !== "/" && canonicalPath.endsWith("/")) {
  canonicalPath = canonicalPath.slice(0, -1);
}

// Manually handle known redirects for canonical URLs
let finalPath = canonicalPath;
const knownRedirects: {[key: string]: string} = {
  "/news/switching-health-insurance-in-switzerland": "/healthcare/switching-health-insurance",
  "/guides/relocation/zurich-vs-zug-comparison": "/blog/zurich-vs-zug-choosing-ideal-swiss-relocation-destination",
  "/guides/relocation/zurich-relocation-costs": "/blog/hidden-costs-zurich-relocation-budget-planning-expats",
  "/contact": "/free-consultation"
};

if (knownRedirects[canonicalPath]) {
  finalPath = knownRedirects[canonicalPath];
}

// Always add trailing slash to canonical paths (except homepage)
if (finalPath !== "/" && !finalPath.endsWith("/")) {
  finalPath = finalPath + "/";
}

const canonicalURL = canonicalURLProp || new URL(finalPath, Astro.site || "https://expat-savvy.ch").toString();
const finalCanonicalURL = canonicalURL.endsWith('/') ? canonicalURL : canonicalURL + '/';

// Define CDN URLs
const cdnBaseUrl = "https://res.cloudinary.com/dphbnwjtx/";
const logoLight = `${cdnBaseUrl}image/upload/v1740080076/logo_light_expatsavvy_o8iaky.svg`;
const logoDark = `${cdnBaseUrl}image/upload/v1740080077/logoexpatsavvy_sykutm.svg`;
const favicon = "https://res.cloudinary.com/dphbnwjtx/image/upload/f_auto,q_auto/v1740666308/expat_savvy_logo-1_qbkfl2_1_efj2bj.png";
---
<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    
    <!-- Preconnect to critical domains only -->
    <link rel="preconnect" href={cdnBaseUrl} crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- DNS prefetch for analytics (lighter than preconnect, non-blocking) -->
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    <link rel="dns-prefetch" href="https://connect.facebook.net" />
    
    <!-- Preload critical assets -->
    <link rel="preload" as="image" href={logoDark} fetchpriority="high" />
    
    <!-- Canonical and metadata -->
    <link rel="canonical" href={finalCanonicalURL} />
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href={favicon} sizes="32x32" />
    <link rel="icon" type="image/png" href={favicon} sizes="16x16" />
    <link rel="apple-touch-icon" href={favicon} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Facebook Domain Verification -->
    <meta name="facebook-domain-verification" content="y9dvho8xcoxq52cbdoplkzvsmw1seo" />
    
    <!-- Social Media Image -->
    <SocialMediaImage 
      image={image}
      alt={description}
      width={1200}
      height={630}
    />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={finalCanonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:site_name" content="Expat Savvy" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={finalCanonicalURL} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    
    <!-- Additional Meta Tags -->
    <meta name="author" content="Expat Savvy" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="msvalidate.01" content="425777CCEABBA1795F709019A3876A41" />
    
    <!-- Plausible Analytics (Cookieless, deferred) -->
    <script defer data-domain="expat-savvy.ch" src="https://plausible.io/js/script.js"></script>
    <script defer src="/scripts/plausible-tracking.js"></script>
    <script defer src="/scripts/enhanced-plausible-tracking.js"></script>
    
    <slot name="head" />
  </head>
  <body class="min-h-screen bg-gray-50 overflow-x-hidden">
    <Header />
    <main>
      <slot />
    </main>
    <Footer />
    
    <!-- Modals -->
    <VAG45Modal />
    <PrivacyPolicyModal />
    <TermsOfServiceModal />
    
    <!-- Hidden Netlify Forms for detection -->
    <form name="health-insurance" method="POST" data-netlify="true" netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input type="tel" name="phone" />
      <input type="text" name="insurance-type" />
      <input type="text" name="dob" />
      <input type="text" name="address" />
      <input type="text" name="postcode" />
      <input type="text" name="city" />
      <input type="text" name="canton" />
      <textarea name="special-requirements"></textarea>
      <input type="text" name="bot-field" />
    </form>

    <form name="life-pension" method="POST" data-netlify="true" netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input type="tel" name="phone" />
      <input type="text" name="product-type" />
      <textarea name="special-requirements"></textarea>
    </form>

    <form name="other-insurance" method="POST" data-netlify="true" netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input type="tel" name="phone" />
      <input type="text" name="insurance-types" />
      <input type="text" name="address" />
      <input type="text" name="postcode" />
      <input type="text" name="city" />
      <input type="date" name="insurance-start-date" />
      <textarea name="special-requirements"></textarea>
    </form>

    <form name="relocation-consultation" method="POST" data-netlify="true" netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input type="tel" name="phone" />
      <input type="text" name="relocation-type" />
      <input type="date" name="moving-date" />
      <textarea name="special-requirements"></textarea>
    </form>
    
    <!-- Modal Overlay System (single instance) -->
    <script is:inline src="/scripts/modal-overlay-system.js"></script>
    
    <!-- 
      ANALYTICS: Loaded at end of body for better performance
      Google Tag sets consent defaults, then loads gtag.js
      Facebook Pixel respects consent state
    -->
    <GoogleTag />
    <FacebookPixel />
    
    <!-- Cookie Consent Banner -->
    <CookieBanner />
  </body>
</html>
