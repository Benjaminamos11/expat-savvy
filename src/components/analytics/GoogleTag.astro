---
/**
 * Google Tag Component with Consent Mode v2
 * 
 * PERFORMANCE OPTIMIZED:
 * - Consent defaults set synchronously (required for compliance)
 * - gtag.js loaded with async (non-blocking)
 * - Placed at end of body for better LCP
 * 
 * IDs:
 * - GA4: G-8M24FL4XQQ
 * - Google Ads: AW-11375797246
 */

const GA4_ID = 'G-8M24FL4XQQ';
const GOOGLE_ADS_ID = 'AW-11375797246';
---

<!-- Google Consent Mode v2: Set defaults (must be sync for compliance) -->
<script is:inline define:vars={{ GA4_ID, GOOGLE_ADS_ID }}>
  // Initialize dataLayer
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  
  // Set consent defaults BEFORE loading gtag.js
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied',
    'functionality_storage': 'granted',
    'personalization_storage': 'denied',
    'security_storage': 'granted',
    'wait_for_update': 500
  });
  
  // Region-specific defaults for stricter regions
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied', 
    'ad_personalization': 'denied',
    'analytics_storage': 'denied',
    'region': ['CH', 'AT', 'DE', 'FR', 'IT', 'GB', 'ES', 'NL', 'BE', 'PL', 'SE', 'DK', 'FI', 'NO', 'IE', 'PT', 'CZ', 'RO', 'HU', 'GR']
  });

  gtag('js', new Date());
  
  // Configure GA4
  gtag('config', GA4_ID, {
    'anonymize_ip': true,
    'allow_google_signals': false,
    'allow_ad_personalization_signals': false,
    'send_page_view': true
  });
  
  // Configure Google Ads
  gtag('config', GOOGLE_ADS_ID, {
    'anonymize_ip': true
  });
  
  // Restore consent from localStorage immediately
  (function() {
    try {
      var consent = localStorage.getItem('cookie_consent');
      if (consent === 'accepted') {
        gtag('consent', 'update', {
          'ad_storage': 'granted',
          'ad_user_data': 'granted',
          'ad_personalization': 'granted',
          'analytics_storage': 'granted',
          'personalization_storage': 'granted'
        });
      }
    } catch (e) {}
  })();
  
  // Global function to update consent
  window.updateGoogleConsent = function(granted) {
    var state = granted ? 'granted' : 'denied';
    gtag('consent', 'update', {
      'ad_storage': state,
      'ad_user_data': state,
      'ad_personalization': state,
      'analytics_storage': state,
      'personalization_storage': state
    });
    window.dispatchEvent(new CustomEvent('consentUpdate', { detail: { granted: granted } }));
  };
</script>

<!-- Load gtag.js async (non-blocking) -->
<script async src={`https://www.googletagmanager.com/gtag/js?id=${GA4_ID}`}></script>
