---
/**
 * Google Tag Component with Consent Mode v2
 * 
 * CONSENT-FIRST LOADING:
 * - Only loads gtag.js AFTER user accepts cookies
 * - Sets consent defaults immediately (required for compliance)
 * - Zero impact on PageSpeed until consent given
 * 
 * IDs:
 * - GA4: G-8M24FL4XQQ
 * - Google Ads: AW-11375797246
 */

const GA4_ID = 'G-8M24FL4XQQ';
const GOOGLE_ADS_ID = 'AW-11375797246';
---

<!-- Google Consent Mode v2: Minimal setup (no external scripts until consent) -->
<script is:inline define:vars={{ GA4_ID, GOOGLE_ADS_ID }}>
(function() {
  'use strict';
  
  // Initialize dataLayer
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  window.gtag = gtag;
  
  // Set consent defaults (required even before loading gtag.js)
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied',
    'analytics_storage': 'denied',
    'functionality_storage': 'granted',
    'personalization_storage': 'denied',
    'security_storage': 'granted',
    'wait_for_update': 500
  });
  
  // Track if gtag.js has been loaded
  var gtagLoaded = false;
  
  // Function to load gtag.js (called when consent is granted)
  window.loadGoogleTag = function() {
    if (gtagLoaded) return;
    gtagLoaded = true;
    
    // Create and inject the script
    var script = document.createElement('script');
    script.async = true;
    script.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA4_ID;
    document.head.appendChild(script);
    
    // Configure after script loads
    script.onload = function() {
      gtag('js', new Date());
      
      // Configure GA4
      gtag('config', GA4_ID, {
        'anonymize_ip': true,
        'send_page_view': true
      });
      
      // Configure Google Ads
      gtag('config', GOOGLE_ADS_ID, {
        'anonymize_ip': true
      });
      
      console.log('[GoogleTag] Scripts loaded and configured');
    };
  };
  
  // Function to update consent
  window.updateGoogleConsent = function(granted) {
    var state = granted ? 'granted' : 'denied';
    
    gtag('consent', 'update', {
      'ad_storage': state,
      'ad_user_data': state,
      'ad_personalization': state,
      'analytics_storage': state,
      'personalization_storage': state
    });
    
    // Load gtag.js if consent granted and not yet loaded
    if (granted && !gtagLoaded) {
      window.loadGoogleTag();
    }
    
    // Dispatch event for other scripts
    window.dispatchEvent(new CustomEvent('consentUpdate', { 
      detail: { granted: granted } 
    }));
  };
  
  // Check for existing consent on page load
  try {
    var consent = localStorage.getItem('cookie_consent');
    if (consent === 'accepted') {
      // User previously accepted - update consent and load scripts
      gtag('consent', 'update', {
        'ad_storage': 'granted',
        'ad_user_data': 'granted',
        'ad_personalization': 'granted',
        'analytics_storage': 'granted',
        'personalization_storage': 'granted'
      });
      // Load gtag.js for returning users who accepted
      window.loadGoogleTag();
    }
  } catch (e) {}
})();
</script>
