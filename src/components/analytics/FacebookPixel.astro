---
/**
 * Facebook/Meta Pixel Component
 * 
 * Shared Pixel ID: 1393006485701609
 * Used for cross-domain retargeting audience building.
 * 
 * Features:
 * - Listens for consent updates from CookieBanner
 * - Revokes consent via fbq('consent', 'revoke') when denied
 * - Supports Advanced Matching when consent is granted
 */

const META_PIXEL_ID = '1393006485701609';
---

<!-- Meta Pixel Code with Consent Integration -->
<script is:inline define:vars={{ META_PIXEL_ID }}>
  // Initialize Meta Pixel with consent awareness
  !function(f,b,e,v,n,t,s) {
    if(f.fbq) return;
    n = f.fbq = function() {
      n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments)
    };
    if(!f._fbq) f._fbq = n;
    n.push = n;
    n.loaded = !0;
    n.version = '2.0';
    n.queue = [];
    t = b.createElement(e);
    t.async = !0;
    t.src = v;
    s = b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t, s);
  }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

  // Check consent status before initialization
  (function() {
    const hasConsent = (function() {
      try {
        return localStorage.getItem('cookie_consent') === 'accepted';
      } catch (e) {
        return false;
      }
    })();

    if (hasConsent) {
      // Full tracking with consent
      fbq('consent', 'grant');
      fbq('init', META_PIXEL_ID);
      fbq('track', 'PageView');
      console.log('[MetaPixel] Initialized with full tracking (consent granted)');
    } else {
      // Initialize with revoked consent - basic analytics only
      fbq('consent', 'revoke');
      fbq('init', META_PIXEL_ID);
      // PageView still fires but with limited data collection
      fbq('track', 'PageView');
      console.log('[MetaPixel] Initialized with limited tracking (consent pending/denied)');
    }
  })();

  // Listen for consent updates from CookieBanner
  window.addEventListener('consentUpdate', function(e) {
    if (e.detail && e.detail.granted) {
      fbq('consent', 'grant');
      console.log('[MetaPixel] Consent granted - full tracking enabled');
    } else {
      fbq('consent', 'revoke');
      console.log('[MetaPixel] Consent revoked - limited tracking only');
    }
  });

  // Global function for custom event tracking
  window.trackMetaEvent = function(eventName, params) {
    if (typeof fbq === 'function') {
      fbq('track', eventName, params || {});
      console.log('[MetaPixel] Event tracked:', eventName, params);
    }
  };

  // Global function for custom conversions
  window.trackMetaCustomEvent = function(eventName, params) {
    if (typeof fbq === 'function') {
      fbq('trackCustom', eventName, params || {});
      console.log('[MetaPixel] Custom event tracked:', eventName, params);
    }
  };
</script>

<!-- Fallback for users with JavaScript disabled -->
<noscript>
  <img 
    height="1" 
    width="1" 
    style="display:none" 
    src={`https://www.facebook.com/tr?id=${META_PIXEL_ID}&ev=PageView&noscript=1`}
    alt=""
  />
</noscript>

