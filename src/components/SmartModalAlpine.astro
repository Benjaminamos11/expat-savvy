---
// Get current page path to determine context
const currentPath = Astro.url.pathname;

// Determine intent based on URL path
let pageIntent = 'home';
if (currentPath.includes('/setup')) pageIntent = 'setup';
else if (currentPath.includes('/change')) pageIntent = 'change';
else if (currentPath.includes('/cheapest')) pageIntent = 'cheapest';
else if (currentPath.includes('/best')) pageIntent = 'best';
else if (currentPath.includes('/compare')) pageIntent = 'compare';
else if (currentPath.includes('/healthcare/all-insurances/')) pageIntent = 'provider';

// Detect city from URL for localization
let city = '';
const cityPatterns = ['zurich', 'basel', 'bern', 'geneva', 'lausanne', 'lugano', 'zug'];
for (const cityName of cityPatterns) {
  if (currentPath.includes(cityName)) {
    city = cityName;
    break;
  }
}

const pageSlug = currentPath.split('/').filter(Boolean).pop() || '';
---

<div 
  x-data="smartModal()" 
  x-init="init()"
  @open-modal.window="open()"
  class="smart-modal-alpine"
>
  <!-- Modal Backdrop -->
  <div 
    x-show="isOpen" 
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50"
    @click="close()"
    @keydown.escape.window="close()"
    style="display: none;"
  >
    <!-- Modal Container -->
    <div 
      class="flex items-center justify-center p-0 lg:p-4 h-full min-h-screen"
      @click.stop
    >
      <div 
        x-show="isOpen"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        class="bg-white w-full h-full lg:max-w-[1200px] lg:max-h-[90vh] lg:rounded-2xl lg:h-auto overflow-y-auto relative shadow-2xl"
      >
        <!-- Close button -->
        <button 
          @click="close()"
          class="absolute top-4 right-4 z-10 p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
          aria-label="Close modal"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        
        <!-- Modal Content -->
        <div class="p-8 lg:p-12">
          <!-- Step 1: Qualification -->
          <div x-show="currentStep === 'qualification'">
            <h2 class="text-3xl font-bold text-center mb-8 text-gray-900">What's your situation?</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto">
              <div 
                @click="selectOption('new-to-switzerland', 9)"
                class="option-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all hover:border-red-500 hover:shadow-lg flex items-center gap-4"
              >
                <div class="text-4xl">🇨🇭</div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">I just moved to Switzerland</div>
                  <div class="text-red-500 font-bold">→</div>
                </div>
              </div>
              
              <div 
                @click="selectOption('family', 8)"
                class="option-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all hover:border-red-500 hover:shadow-lg flex items-center gap-4"
              >
                <div class="text-4xl">👨‍👩‍👧‍👦</div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">I need family coverage</div>
                  <div class="text-red-500 font-bold">→</div>
                </div>
              </div>
              
              <div 
                @click="selectOption('switch-save', 6)"
                class="option-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all hover:border-red-500 hover:shadow-lg flex items-center gap-4"
              >
                <div class="text-4xl">💰</div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">I want to switch and save money</div>
                  <div class="text-red-500 font-bold">→</div>
                </div>
              </div>
              
              <div 
                @click="selectOption('compare-options', 4)"
                class="option-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all hover:border-red-500 hover:shadow-lg flex items-center gap-4"
              >
                <div class="text-4xl">⚖️</div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">I'm comparing different options</div>
                  <div class="text-red-500 font-bold">→</div>
                </div>
              </div>
              
              <div 
                @click="selectOption('have-questions', 3)"
                class="option-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all hover:border-red-500 hover:shadow-lg flex items-center gap-4"
              >
                <div class="text-4xl">❓</div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">I have specific questions</div>
                  <div class="text-red-500 font-bold">→</div>
                </div>
              </div>
              
              <div 
                @click="selectOption('just-browsing', 2)"
                class="option-card bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all hover:border-red-500 hover:shadow-lg flex items-center gap-4"
              >
                <div class="text-4xl">👀</div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">I'm just browsing</div>
                  <div class="text-red-500 font-bold">→</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Step 2: Value Demonstration -->
          <div x-show="currentStep === 'value'">
            <button 
              @click="goToStep('qualification')"
              class="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-6"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Back
            </button>
            
            <div x-show="userData.complexityScore >= 7">
              <h2 class="text-3xl font-bold text-center mb-8 text-gray-900">Perfect! You need expert guidance.</h2>
              <div class="max-w-2xl mx-auto text-center">
                <p class="text-lg text-gray-700 mb-8">Your situation requires personalized advice. Let's book a free consultation to ensure you get the best coverage at the best price.</p>
                
                <button 
                  @click="goToStep('booking')"
                  class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-8 rounded-lg text-lg transition-colors"
                >
                  Book Free Consultation →
                </button>
              </div>
            </div>
            
            <div x-show="userData.complexityScore >= 4 && userData.complexityScore < 7">
              <h2 class="text-3xl font-bold text-center mb-8 text-gray-900">Great choice! Here are your options:</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
                  <h3 class="font-bold text-xl mb-4">Free Consultation</h3>
                  <p class="text-gray-700 mb-6">Get personalized advice and potentially save CHF 800-1,500 per year.</p>
                  <button 
                    @click="goToStep('booking')"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg w-full"
                  >
                    Book Call →
                  </button>
                </div>
                
                <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-6">
                  <h3 class="font-bold text-xl mb-4">Self-Service Quotes</h3>
                  <p class="text-gray-700 mb-6">Get standard quotes in 4-5 minutes.</p>
                  <button 
                    @click="goToStep('booking')"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg w-full"
                  >
                    Get Quotes →
                  </button>
                </div>
              </div>
            </div>
            
            <div x-show="userData.complexityScore < 4">
              <h2 class="text-3xl font-bold text-center mb-8 text-gray-900">No problem! How can I help?</h2>
              <div class="max-w-2xl mx-auto space-y-4">
                <div 
                  @click="goToStep('booking')"
                  class="bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-red-500 hover:shadow-lg transition-all flex items-center gap-4"
                >
                  <div class="text-3xl">📞</div>
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">Quick Call</h3>
                    <p class="text-gray-600">Personalized advice (15 min)</p>
                  </div>
                  <button class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold">
                    Book Now →
                  </button>
                </div>
                
                <div 
                  @click="goToStep('booking')"
                  class="bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer hover:border-red-500 hover:shadow-lg transition-all flex items-center gap-4"
                >
                  <div class="text-3xl">📋</div>
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">Compare Rates</h3>
                    <p class="text-gray-600">Standard quotes (4-5 min)</p>
                  </div>
                  <button class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold">
                    Get Quotes →
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Step 3: Booking Form -->
          <div x-show="currentStep === 'booking'">
            <button 
              @click="goToStep('value')"
              class="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-6"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Back
            </button>
            
            <h2 class="text-3xl font-bold text-center mb-8 text-gray-900">Let's get you set up!</h2>
            
            <form @submit.prevent="submitBooking()" class="max-w-md mx-auto space-y-6">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                <input 
                  x-model="bookingData.name"
                  type="text" 
                  id="name" 
                  required 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                  placeholder="Your full name"
                >
              </div>
              
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <input 
                  x-model="bookingData.email"
                  type="email" 
                  id="email" 
                  required 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                  placeholder="your.email@example.com"
                >
              </div>
              
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                <input 
                  x-model="bookingData.phone"
                  type="tel" 
                  id="phone" 
                  required 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                  placeholder="+41 XX XXX XX XX"
                >
              </div>
              
              <button 
                type="submit"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition-colors"
              >
                Continue to Calendar →
              </button>
            </form>
          </div>
          
          <!-- Step 4: Success -->
          <div x-show="currentStep === 'success'">
            <div class="text-center max-w-2xl mx-auto">
              <div class="text-6xl mb-6">🎉</div>
              <h2 class="text-3xl font-bold text-gray-900 mb-4">Thank you!</h2>
              <p class="text-lg text-gray-700 mb-8">Your booking request has been submitted. We'll contact you shortly to schedule your free consultation.</p>
              
              <div class="bg-green-50 border border-green-200 rounded-xl p-6 mb-8">
                <h3 class="font-bold text-green-900 mb-2">What happens next:</h3>
                <ul class="text-green-800 text-left space-y-2">
                  <li>• We'll call you within 24 hours to confirm your appointment</li>
                  <li>• Prepare any current insurance documents</li>
                  <li>• Get ready to potentially save CHF 800-1,500 per year</li>
                </ul>
              </div>
              
              <button 
                @click="close()"
                class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function smartModal() {
    return {
      isOpen: false,
      currentStep: 'qualification',
      userData: {
        situation: '',
        complexityScore: 0
      },
      bookingData: {
        name: '',
        email: '',
        phone: ''
      },
      
      init() {
        // Make globally accessible
        window.openSmartModal = () => this.open();
        window.closeSmartModal = () => this.close();
        window.smartModalInstance = this;
        
        // Legacy compatibility
        window.openOffersModal = () => this.open();
        window.openConsultationModal = () => this.open();
        
        console.log('✅ Smart Modal Alpine initialized');
      },
      
      open() {
        console.log('🎯 SmartModal open() called - setting isOpen to true');
        this.isOpen = true;
        document.body.style.overflow = 'hidden';
        console.log('🚀 Smart Modal opened, isOpen:', this.isOpen);
      },
      
      close() {
        this.isOpen = false;
        document.body.style.overflow = '';
        this.currentStep = 'qualification';
        console.log('🔒 Smart Modal closed');
      },
      
      goToStep(step) {
        this.currentStep = step;
        console.log(`📍 Navigated to step: ${step}`);
      },
      
      selectOption(situation, score) {
        this.userData.situation = situation;
        this.userData.complexityScore = score;
        this.goToStep('value');
        console.log(`🎯 Selected: ${situation} (score: ${score})`);
      },
      
      submitBooking() {
        if (this.bookingData.name && this.bookingData.email && this.bookingData.phone) {
          console.log('📝 Booking submitted:', this.bookingData);
          this.goToStep('success');
        } else {
          alert('Please fill in all fields');
        }
      }
    }
  }
</script>

<!-- Alpine.js CDN -->
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Compatibility Script for Existing CTA Buttons -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('🔧 Setting up Alpine Smart Modal compatibility');
  
  // Wait for Alpine to initialize
  setTimeout(() => {
    // Create global functions that existing buttons can call
    window.openSmartModal = function() {
      console.log('📞 openSmartModal called - triggering Alpine modal');
      window.dispatchEvent(new CustomEvent('open-modal'));
    };
    
    window.openOffersModal = function() {
      console.log('📞 openOffersModal called - triggering Alpine modal');
      window.dispatchEvent(new CustomEvent('open-modal'));
    };
    
    window.openConsultationModal = function() {
      console.log('📞 openConsultationModal called - triggering Alpine modal');
      window.dispatchEvent(new CustomEvent('open-modal'));
    };
    
    window.showConsultationModal = function() {
      console.log('📞 showConsultationModal called - triggering Alpine modal');
      window.dispatchEvent(new CustomEvent('open-modal'));
    };
    
    console.log('✅ Alpine Smart Modal compatibility functions created');
    
    // Also enhance any buttons that have onclick handlers
    const buttonsWithOnclick = document.querySelectorAll('button[onclick], a[onclick]');
    buttonsWithOnclick.forEach(button => {
      const onclickAttr = button.getAttribute('onclick');
      if (onclickAttr && (
        onclickAttr.includes('openOffersModal') || 
        onclickAttr.includes('openConsultationModal') || 
        onclickAttr.includes('showConsultationModal')
      )) {
        console.log('🔧 Enhancing button:', button.textContent?.trim());
        
        // Remove the onclick and add our event listener
        button.removeAttribute('onclick');
        button.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('🚀 Button clicked - opening Alpine modal');
          window.dispatchEvent(new CustomEvent('open-modal'));
        });
      }
    });
    
    // Find buttons by text content and class
    const consultationButtons = document.querySelectorAll(
      'button, a, .btn, .button, .cta-button, .hero-cta'
    );
    
    consultationButtons.forEach(button => {
      const buttonText = button.textContent?.toLowerCase().trim() || '';
      const isConsultationButton = 
        buttonText.includes('consultation') || 
        buttonText.includes('contact us') ||
        buttonText.includes('get advice') ||
        buttonText.includes('book') ||
        buttonText.includes('free advice') ||
        buttonText.includes('get started') ||
        button.classList.contains('consultation-button') ||
        button.hasAttribute('data-open-consultation');
        
      if (isConsultationButton && !button.hasAttribute('data-alpine-enhanced')) {
        console.log('🔧 Enhancing consultation button:', buttonText);
        button.setAttribute('data-alpine-enhanced', 'true');
        
        button.addEventListener('click', (e) => {
          // Only prevent default if it's a link to # or contains modal functions
          const href = button.getAttribute('href');
          if (href === '#' || href === 'javascript:void(0)' || button.hasAttribute('onclick')) {
            e.preventDefault();
          }
          
          console.log('🚀 Consultation button clicked - opening Alpine modal');
          window.dispatchEvent(new CustomEvent('open-modal'));
        });
      }
    });
    
    console.log('✅ Alpine Smart Modal button enhancement complete');
  }, 1000); // Wait 1 second for Alpine to fully load
});
</script>