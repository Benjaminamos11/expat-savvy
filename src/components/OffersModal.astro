---
// Get current page path to determine context
const currentPath = Astro.url.pathname;

// Determine intent based on URL path
let pageIntent = 'home';
if (currentPath.includes('/setup')) pageIntent = 'setup';
else if (currentPath.includes('/change')) pageIntent = 'change';
else if (currentPath.includes('/cheapest')) pageIntent = 'cheapest';
else if (currentPath.includes('/best')) pageIntent = 'best';
else if (currentPath.includes('/compare')) pageIntent = 'compare';
else if (currentPath.includes('/healthcare/all-insurances/')) pageIntent = 'provider';

const pageSlug = currentPath.split('/').filter(Boolean).pop() || '';
---

<div id="offers-modal" 
    class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50"
    data-page-intent={pageIntent} 
    data-page-slug={pageSlug}
    role="dialog"
    aria-modal="true">
  
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl max-w-6xl w-full max-h-[95vh] overflow-hidden shadow-2xl relative">

      <!-- Close button -->
      <button id="close-modal-btn" class="absolute top-4 right-4 z-10 p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- Mobile Layout -->
      <div class="lg:hidden">
        <!-- Progress bar -->
        <div class="h-2 bg-gray-200">
          <div id="mobile-progress-bar" class="h-full bg-red-500 transition-all duration-300" style="width: 0%"></div>
        </div>
        
        <!-- Content -->
        <div id="mobile-content" class="p-6 overflow-y-auto" style="max-height: calc(95vh - 80px);">
          <!-- Will be populated by JavaScript -->
        </div>
        
        <!-- Footer -->
        <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 flex gap-3">
          <button id="mobile-back-btn" class="hidden px-4 py-2 text-gray-600 border border-gray-300 rounded-lg">Back</button>
          <button id="mobile-next-btn" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold">Next â†’</button>
        </div>
      </div>
      
      <!-- Desktop Layout -->
      <div class="hidden lg:flex">
        <!-- Left: Content -->
        <div class="flex-1 p-8 overflow-y-auto">
          <div id="desktop-content">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Right: Sidebar -->
        <div class="w-80 bg-gray-50 p-6 border-l border-gray-200">
          <div class="space-y-6">
            <!-- Robert's info -->
            <div class="text-center">
              <img 
                src="https://res.cloudinary.com/dphbnwjtx/image/upload/w_112,h_112,q_80,f_auto,c_fill,g_face/v1747501071/6758848048b5cdaf6ebe884f_WhatsApp_Image_2024-12-11_at_01.55.01_oruhjs.webp"
                alt="Robert â€” Expat Savvy Advisor"
                class="w-28 h-28 rounded-full mx-auto mb-4"
              />
              <h3 class="font-semibold text-gray-900">Robert Kolar</h3>
              <p class="text-sm text-gray-600 mb-2">FINMA Registered Advisor</p>
              <div class="flex justify-center gap-2">
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">English</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">German</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Slovak</span>
              </div>
            </div>
            
            <!-- What to expect -->
            <div class="bg-white rounded-lg p-4 border border-gray-200">
              <h4 class="font-semibold text-gray-900 mb-3">What to expect</h4>
              <ul class="space-y-2 text-sm text-gray-600">
                <li>â€¢ Personal advice in English</li>
                <li>â€¢ Compare all major insurers</li>
                <li>â€¢ Free & no obligation</li>
              </ul>
            </div>
          </div>
          
          <!-- Secondary CTA -->
          <button id="sidebar-consultation-btn" class="w-full border-2 border-red-600 text-red-600 py-3 px-4 rounded-lg font-semibold hover:bg-red-50 transition-colors mt-6">
            Book Free Consultation
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('ðŸš€ OffersModal loading...');
  
  const modal = document.getElementById('offers-modal');
  if (!modal) return;
  
  let currentStep = 'intro';
  let formData = {};
  
  // Get social proof count from homepage
  function getSocialProofCount() {
    const existingCount = document.getElementById('booking-count');
    if (existingCount) {
      const match = existingCount.textContent?.match(/(\d+) people/);
      if (match) return match[1];
    }
    // Fallback: generate consistent daily number
    const today = new Date();
    const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
    const random = ((seed * 9301 + 49297) % 233280) / 233280;
    return Math.floor(random * 9) + 3;
  }
  
  // Render intro step
  function renderIntro() {
    const socialCount = getSocialProofCount();
    
    return `
      <div class="text-center mb-8">
        <h2 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-3">Find Your Best Swiss Health Insurance in Minutes</h2>
        <p class="text-gray-600 mb-4">Personal, English-speaking advice. Free & no obligation.</p>
        
        <div class="inline-flex items-center bg-green-50 border border-green-200 rounded-full px-3 py-1 text-sm text-green-800 mb-6">
          <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2v-6a2 2 0 012-2h8z" />
          </svg>
          ${socialCount} people booked consultations in the last 24 hours
        </div>
      </div>
      
      <div class="space-y-4">
        <button id="start-offers-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-lg font-semibold text-lg transition-colors">
          <div class="flex items-center justify-center">
            <svg class="w-5 h-5 mr-2 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 9-14 9V3z" />
            </svg>
            <div class="text-white">
              <div class="font-semibold">Get 3 Best Offers</div>
              <div class="text-green-100 text-sm font-normal mt-1">Takes ~1 min</div>
            </div>
          </div>
        </button>
        
        <button id="consultation-btn" class="w-full border-2 border-red-600 text-red-600 py-3 px-6 rounded-lg font-semibold hover:bg-red-50 transition-colors">
          <div class="flex items-center justify-center">
            <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
            </svg>
            <div class="text-red-600">
              <div class="font-semibold">Book Free Consultation</div>
              <div class="text-red-500 text-sm font-normal mt-1">30â€“60 min video call</div>
            </div>
          </div>
        </button>
      </div>
    `;
  }
  
  // Render content
  function renderContent() {
    const mobileContent = document.getElementById('mobile-content');
    const desktopContent = document.getElementById('desktop-content');
    
    if (currentStep === 'intro') {
      const introHTML = renderIntro();
      if (mobileContent) mobileContent.innerHTML = introHTML;
      if (desktopContent) desktopContent.innerHTML = introHTML;
      
      // Add event listeners
      setTimeout(() => {
        document.getElementById('start-offers-btn')?.addEventListener('click', () => {
          console.log('ðŸš€ Get 3 Best Offers clicked');
          alert('Form flow will be implemented - this confirms the button works!');
        });
        
        document.getElementById('consultation-btn')?.addEventListener('click', () => {
          console.log('ðŸ“… Book Consultation clicked');
          window.open('https://cal.com/robertkolar/change-health-insurance', '_blank');
        });
      }, 100);
    }
  }
  
  // Open modal
  function openModal() {
    console.log('ðŸš€ Opening OffersModal');
    currentStep = 'intro';
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    renderContent();
    console.log('âœ… OffersModal opened');
  }
  
  // Close modal
  function closeModal() {
    console.log('ðŸ”’ Closing OffersModal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
    console.log('âœ… OffersModal closed');
  }
  
  // Event listeners
  document.getElementById('close-modal-btn')?.addEventListener('click', closeModal);
  document.getElementById('sidebar-consultation-btn')?.addEventListener('click', () => {
    window.open('https://cal.com/robertkolar/change-health-insurance', '_blank');
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });
  
  // Global functions
  window.openOffersModal = openModal;
  window.showConsultationModal = openModal; // Legacy compatibility
  
  console.log('âœ… OffersModal initialized');
});
</script>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  #offers-modal:not(.hidden) {
    animation: fadeIn 0.2s ease-out;
  }
  
  @media (prefers-reduced-motion: reduce) {
    * { animation: none !important; transition: none !important; }
  }
</style>