---
// Get current page path to determine context
const currentPath = Astro.url.pathname;

// Determine intent based on URL path
let pageIntent = 'home';
if (currentPath.includes('/setup')) pageIntent = 'setup';
else if (currentPath.includes('/change')) pageIntent = 'change';
else if (currentPath.includes('/cheapest')) pageIntent = 'cheapest';
else if (currentPath.includes('/best')) pageIntent = 'best';
else if (currentPath.includes('/compare')) pageIntent = 'compare';
else if (currentPath.includes('/healthcare/all-insurances/')) pageIntent = 'provider';

const pageSlug = currentPath.split('/').filter(Boolean).pop() || '';
---

<div id="offers-modal" 
    class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50"
    data-page-intent={pageIntent} 
    data-page-slug={pageSlug}
    role="dialog"
    aria-modal="true">
  


  <div class="flex items-center justify-center p-4 lg:p-4 p-0 h-full min-h-screen">
    <div class="bg-white rounded-3xl max-w-6xl w-full overflow-y-auto max-h-[100dvh] lg:max-h-[95vh] relative shadow-2xl transition-all duration-200 scale-100 translate-y-0 h-full lg:h-auto">

      <!-- Close button - Enhanced mobile touch target -->
      <button id="close-modal-btn" class="absolute top-3 right-3 lg:top-4 lg:right-4 z-10 p-3 lg:p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- Mobile Layout - Optimized for full viewport -->
      <div class="lg:hidden pointer-events-auto h-full flex flex-col min-h-full">
        <!-- Progress bar - Enhanced visibility -->
        <div class="h-1 bg-gray-200 flex-shrink-0">
          <div id="mobile-progress-bar" class="h-full bg-gradient-to-r from-red-500 to-red-600 transition-all duration-300 shadow-sm" style="width: 0%"></div>
        </div>
        
        <!-- Content - Optimized for single screen view -->
        <div id="mobile-content" class="flex-1 p-3 overflow-y-auto pointer-events-auto bg-white" style="padding-bottom: max(0.75rem, env(safe-area-inset-bottom)); min-height: 500px;">
          <!-- Content will be populated by JavaScript -->
        </div>
        
        <!-- Footer - Safe area optimized (Back button only) -->
        <div class="flex-shrink-0 bg-gray-50 border-t border-gray-200 p-4 shadow-lg" style="padding-bottom: max(1rem, env(safe-area-inset-bottom));">
          <button id="mobile-back-btn" class="hidden w-full px-4 py-3 text-gray-600 border border-gray-300 rounded-lg min-h-[48px] font-medium">Back</button>
        </div>
      </div>
      
      <!-- Desktop Layout -->
      <div class="hidden lg:block pointer-events-auto" id="desktop-content">
        <!-- Dynamic content will be injected here by JavaScript -->
      </div>
    </div>
  </div>
</div>

<script>
// EMERGENCY FIX: Create openOffersModal function immediately
(function() {
  console.log('üö® EMERGENCY: Creating openOffersModal function immediately');

  window.openOffersModal = function() {
    console.log('üöÄ EMERGENCY: openOffersModal called');
    
    const modal = document.getElementById('offers-modal');
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.body.classList.add('modal-open');
      console.log('‚úÖ EMERGENCY: Modal opened via direct method');
    } else {
      console.error('‚ùå EMERGENCY: Modal element not found');
    }
  };

  // Legacy compatibility
  window.showConsultationModal = window.openOffersModal;
  window.openConsultationModal = window.openOffersModal;

  console.log('‚úÖ EMERGENCY: openOffersModal function created and available');
  
  // Also try to override any existing debugging functions
  setTimeout(function() {
    if (typeof window.openOffersModal !== 'function') {
      console.error('‚ùå EMERGENCY: Function was overridden!');
    } else {
      console.log('‚úÖ EMERGENCY: Function still exists after 1 second');
    }
  }, 1000);
})();
</script>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  #offers-modal:not(.hidden) {
    animation: fadeIn 0.2s ease-out;
  }
  
  @media (prefers-reduced-motion: reduce) {
    * { animation: none !important; transition: none !important; }
  }

  #offers-modal button {
    pointer-events: auto !important; /* Force enable clicks on buttons */
    user-select: auto;
  }
  #offers-modal .flex {
    pointer-events: auto; /* Enable on flex wrappers */
  }

  /* Mobile-specific optimizations */
  @media (max-width: 1023px) {
    /* Ensure modal uses full height on mobile */
    #offers-modal .bg-white {
      border-radius: 1.5rem 1.5rem 0 0; /* Rounded top only on mobile */
      margin: 0;
      height: 100dvh;
      max-height: 100dvh;
    }
    
    /* Safe area support for newer phones */
    #mobile-content {
      padding-top: max(1rem, env(safe-area-inset-top));
    }
    
    /* Form inputs optimized for mobile */
    #mobile-content input,
    #mobile-content select,
    #mobile-content textarea {
      font-size: 16px; /* Prevent iOS zoom */
      min-height: 44px; /* iOS recommended touch target */
    }
    
    /* Better button spacing */
    #mobile-content button {
      min-height: 48px;
      touch-action: manipulation; /* Prevent double-tap zoom */
    }
    
    /* Optimize mobile content for single screen */
    #mobile-content .space-y-6 {
      gap: 1rem; /* Reduce spacing between form sections */
    }
    
    #mobile-content .mb-8 {
      margin-bottom: 1.5rem; /* Reduce large margins */
    }
    
    #mobile-content .mb-6 {
      margin-bottom: 1rem; /* Reduce medium margins */
    }
    
    /* Compact mobile form elements */
    #mobile-content .text-center {
      margin-bottom: 1rem;
    }
    
    #mobile-content h2 {
      font-size: 1.5rem; /* Smaller headings on mobile */
      margin-bottom: 0.5rem;
    }
    
    #mobile-content p {
      margin-bottom: 0.75rem;
    }
  }
  
  /* Enhanced progress bar */
  #mobile-progress-bar {
    box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
  }
</style>

<!-- Add Lucide script before our offers-modal.js -->
<script src="https://unpkg.com/lucide@0.244.0/dist/umd/lucide.js"></script>

<!-- Include the OffersModal class logic (loads after Lucide) -->
<script src="/scripts/offers-modal.js?v=2.3.0" is:inline></script>