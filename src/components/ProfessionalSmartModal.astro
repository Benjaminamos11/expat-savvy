---
// Get current page context for dynamic modal behavior
const currentPath = Astro.url.pathname;

// Determine intent based on URL path
let pageIntent = 'home';
if (currentPath.includes('/setup') || currentPath.includes('/new-health')) pageIntent = 'setup';
else if (currentPath.includes('/family') || currentPath.includes('/coverage')) pageIntent = 'family';  
else if (currentPath.includes('/change') || currentPath.includes('/switch')) pageIntent = 'change';
else if (currentPath.includes('/cheapest')) pageIntent = 'cheapest';
else if (currentPath.includes('/best')) pageIntent = 'best';
else if (currentPath.includes('/compare')) pageIntent = 'compare';
else if (currentPath.includes('/healthcare/all-insurances/')) pageIntent = 'provider';

// Detect city from URL
let city = '';
const cityPatterns = ['zurich', 'basel', 'bern', 'geneva', 'lausanne', 'lugano', 'zug'];
for (const cityName of cityPatterns) {
  if (currentPath.includes(cityName)) {
    city = cityName;
    break;
  }
}

// Extract provider name for provider pages
let providerName = '';
if (pageIntent === 'provider') {
  const pathParts = currentPath.split('/');
  providerName = pathParts[pathParts.length - 1]?.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || '';
}
---

<!-- React Modal Container -->
<div id="professional-modal-container"></div>

<!-- React CDN -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script>
console.log('🚀 Starting Professional Smart Modal Setup...');

// Wait for React to be available
function initProfessionalModal() {
  if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
    console.log('⏳ Waiting for React...');
    setTimeout(initProfessionalModal, 100);
    return;
  }
  
  console.log('✅ React loaded successfully');
  
  const { useState, useEffect, createElement: h } = React;
  
  // Professional icon components (SVG)
  const XIcon = () => h('svg', { className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M6 18L18 6M6 6l12 12' })
  );
  
  const ArrowLeftIcon = () => h('svg', { className: 'w-4 h-4', fill: 'currentColor', viewBox: '0 0 20 20' },
    h('path', { fillRule: 'evenodd', d: 'M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z', clipRule: 'evenodd' })
  );
  
  const ArrowRightIcon = () => h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
    h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: '2', d: 'M14 5l7 7m0 0l-7 7m7-7H3' })
  );

  const CheckIcon = () => h('svg', { className: 'w-5 h-5', fill: 'currentColor', viewBox: '0 0 20 20' },
    h('path', { fillRule: 'evenodd', d: 'M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z', clipRule: 'evenodd' })
  );

  const SmartModal = ({ isOpen, onClose, pageContext = {} }) => {
    const [currentStep, setCurrentStep] = useState('qualification');
    const [userData, setUserData] = useState({});
    const [formData, setFormData] = useState({ name: '', email: '', phone: '' });

    // Reset modal when opened
    useEffect(() => {
      if (isOpen) {
        setCurrentStep('qualification');
        setUserData({});
        setFormData({ name: '', email: '', phone: '' });
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }, [isOpen]);

    // Close on ESC key
    useEffect(() => {
      const handleKeyDown = (e) => {
        if (e.key === 'Escape' && isOpen) {
          onClose();
        }
      };
      
      if (isOpen) {
        document.addEventListener('keydown', handleKeyDown);
      }
      
      return () => {
        document.removeEventListener('keydown', handleKeyDown);
      };
    }, [isOpen, onClose]);

    const getStepOneConfig = (pageIntent) => {
      switch(pageIntent) {
        case 'setup':
          return {
            headline: "Welcome to Switzerland!",
            subline: "You have 3 months to register. Let's get started.",
            question: "What best describes your situation?",
            highlightedOption: 'new-to-switzerland',
            badge: 'RECOMMENDED FOR YOU'
          };
        
        case 'family':
          return {
            headline: "Let's optimize your family's coverage",
            subline: "Most families save CHF 1,200-2,800 with expert help",
            question: "Tell me about your situation:",
            highlightedOption: 'family',
            badge: 'SUGGESTED FOR FAMILIES'
          };
        
        case 'change':
          return {
            headline: "Ready to switch for 2026?",
            subline: "Switching deadline is 30 November 2025",
            question: "What's your goal?",
            highlightedOption: 'switch-save',
            badge: 'POPULAR CHOICE'
          };
        
        case 'compare':
          return {
            headline: "Comparing your options?",
            subline: "Let me help you choose the right one",
            question: "What brings you here?",
            highlightedOption: 'compare-options',
            badge: 'FASTEST WAY'
          };
        
        case 'provider':
          return {
            headline: `Interested in ${pageContext.providerName || 'this provider'}?`,
            subline: "Let's see if it's the best fit for you",
            question: "What's your interest?",
            highlightedOption: 'compare-options',
            badge: 'SMART APPROACH'
          };
        
        default:
          return {
            headline: "What's your situation?",
            subline: "Personal, English-speaking advice. Free & no obligation.",
            question: "What brings you here today?",
            highlightedOption: null,
            badge: null
          };
      }
    };

    const stepConfig = getStepOneConfig(pageContext.intent || 'home');

    const qualificationOptions = [
      { id: 'new-to-switzerland', icon: '🇨🇭', title: 'I just moved to Switzerland', score: 9 },
      { id: 'switch-save', icon: '💰', title: 'I want to switch & save money', score: 8 },
      { id: 'family', icon: '👨‍👩‍👧', title: 'I need advice for my family', score: 8 },
      { id: 'review-coverage', icon: '🔍', title: 'I want to review my coverage', score: 5 },
      { id: 'cross-border', icon: '🌍', title: "I'm a cross-border worker", score: 9 },
      { id: 'comparing', icon: '📊', title: 'Just comparing options', score: 3 }
    ];

    const handleOptionSelect = (option) => {
      setUserData({
        situation: option.id,
        complexityScore: option.score
      });
      setCurrentStep('value');
    };

    const goToStep = (step) => {
      setCurrentStep(step);
    };

    const handleBookingSubmit = (e) => {
      e.preventDefault();
      if (formData.name && formData.email && formData.phone) {
        setUserData(prev => ({ ...prev, bookingData: formData }));
        setCurrentStep('success');
      } else {
        alert('Please fill in all fields');
      }
    };

    const getValueStep = () => {
      const { complexityScore } = userData;
      if (complexityScore >= 7) return 'value-high';
      if (complexityScore >= 4) return 'value-medium';
      return 'value-low';
    };

    const getSituationInsights = (situation) => {
      switch(situation) {
        case 'new-to-switzerland':
          return [
            { title: 'Permit type affects pricing', desc: 'B, C, L permits have different insurer acceptance and rates' },
            { title: '3-month registration deadline', desc: 'Timing impacts available discounts and options' },
            { title: 'Expat-specific packages exist', desc: 'Most comparison sites don\'t show these specialized plans' }
          ];
        case 'family':
          return [
            { title: 'Children often cheaper separately', desc: 'Under 18s may cost less on individual policies vs family plans' },
            { title: 'Spouse combinations save 15-20%', desc: 'Strategic policy pairing beats individual coverage' },
            { title: 'Family deductible strategies differ', desc: 'Optimal approach varies significantly from singles' }
          ];
        case 'cross-border':
          return [
            { title: 'EU/EFTA exemption options', desc: 'LAMal/CMU choice available for eligible workers' },
            { title: 'Double taxation coordination', desc: 'Complex rules most sites don\'t account for properly' },
            { title: 'Registration timing matters', desc: 'Determines which country\'s system applies' }
          ];
        default:
          return [
            { title: 'Hidden discounts available', desc: 'Many insurers offer unpublished rates for specific situations' },
            { title: 'Timing affects pricing', desc: 'Strategic switching dates can save hundreds annually' },
            { title: 'Personalized optimization', desc: 'Generic comparisons miss individual savings opportunities' }
          ];
      }
    };

    if (!isOpen) return null;

    const modalStyles = {
      backdrop: {
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        backdropFilter: 'blur(4px)',
        zIndex: 9999,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '0'
      },
      container: {
        backgroundColor: 'white',
        width: '100%',
        height: '100%',
        maxWidth: '1200px',
        maxHeight: '90vh',
        borderRadius: '1rem',
        overflowY: 'auto',
        position: 'relative',
        boxShadow: '0 20px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.1)'
      },
      closeButton: {
        position: 'absolute',
        top: '1rem',
        right: '1rem',
        zIndex: 10,
        padding: '0.5rem',
        color: '#6B7280',
        borderRadius: '0.5rem',
        border: 'none',
        background: 'transparent',
        cursor: 'pointer',
        minWidth: '44px',
        minHeight: '44px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        transition: 'color 0.2s'
      },
      content: {
        padding: '3rem'
      }
    };

    return h('div', { style: modalStyles.backdrop },
      h('div', { style: modalStyles.container },
        // Close Button
        h('button', {
          onClick: onClose,
          style: modalStyles.closeButton,
          onMouseEnter: (e) => { e.target.style.color = '#1F2937'; },
          onMouseLeave: (e) => { e.target.style.color = '#6B7280'; }
        }, h(XIcon)),

        h('div', { style: modalStyles.content },
          
          // Step 1: Qualification
          currentStep === 'qualification' && h('div', {
            style: { display: 'flex', flexDirection: 'column', gap: '2rem' }
          },
            // Header
            h('div', { style: { textAlign: 'center' } },
              h('h1', { 
                style: { 
                  fontSize: '2rem', 
                  fontWeight: 'bold', 
                  color: '#1F2937', 
                  marginBottom: '1rem',
                  lineHeight: '1.2'
                } 
              }, stepConfig.headline),
              h('p', { 
                style: { 
                  fontSize: '1.125rem', 
                  color: '#6B7280', 
                  marginBottom: '0.5rem' 
                } 
              }, stepConfig.subline),
              h('p', { 
                style: { 
                  fontSize: '1.25rem', 
                  fontWeight: '600', 
                  color: '#1F2937' 
                } 
              }, stepConfig.question)
            ),

            // Social Proof Bar
            h('div', {
              style: {
                background: '#F9FAFB',
                border: '1px solid #E5E7EB',
                borderRadius: '8px',
                padding: '1rem 1.5rem',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                flexWrap: 'wrap',
                gap: '1rem'
              }
            },
              h('div', { style: { fontSize: '0.875rem', color: '#6B7280', display: 'flex', alignItems: 'center', gap: '0.5rem' } },
                h('span', {}, '👥'),
                h('span', {}, '12 people booked today')
              ),
              h('div', { style: { fontSize: '0.875rem', color: '#6B7280', display: 'flex', alignItems: 'center', gap: '0.5rem' } },
                h('span', {}, '💰'),
                h('span', {}, 'Avg savings: CHF 1,847')
              ),
              h('div', { style: { fontSize: '0.875rem', color: '#6B7280' } },
                '⭐⭐⭐⭐⭐ 4.9/5 (500+)'
              )
            ),

            // Options Grid
            h('div', { 
              style: { 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', 
                gap: '1rem', 
                maxWidth: '1000px', 
                margin: '0 auto' 
              } 
            },
              ...qualificationOptions.map(option => {
                const isHighlighted = option.id === stepConfig.highlightedOption;
                
                return h('div', {
                  key: option.id,
                  onClick: () => handleOptionSelect(option),
                  style: {
                    position: 'relative',
                    backgroundColor: 'white',
                    border: isHighlighted ? '2px solid #10B981' : '2px solid #E5E7EB',
                    borderRadius: '0.75rem',
                    padding: '1.5rem',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease-in-out',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'space-between',
                    minHeight: '120px',
                    background: isHighlighted ? 'linear-gradient(135deg, #FFFFFF 0%, #F0FDF4 100%)' : 'white',
                    boxShadow: isHighlighted 
                      ? '0 10px 15px -3px rgb(16 185 129 / 0.15), 0 4px 6px -2px rgb(16 185 129 / 0.05)' 
                      : '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
                    transform: isHighlighted ? 'translateY(-2px)' : 'translateY(0)'
                  },
                  onMouseEnter: (e) => {
                    if (!isHighlighted) {
                      e.target.style.borderColor = '#EF4444';
                      e.target.style.background = '#FEF2F2';
                      e.target.style.transform = 'translateY(-2px)';
                      e.target.style.boxShadow = '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)';
                    }
                  },
                  onMouseLeave: (e) => {
                    if (!isHighlighted) {
                      e.target.style.borderColor = '#E5E7EB';
                      e.target.style.background = 'white';
                      e.target.style.transform = 'translateY(0)';
                      e.target.style.boxShadow = '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)';
                    }
                  }
                },
                  isHighlighted && stepConfig.badge && h('div', {
                    style: {
                      position: 'absolute',
                      top: '-12px',
                      left: '16px',
                      backgroundColor: '#10B981',
                      color: 'white',
                      fontSize: '11px',
                      fontWeight: '700',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      padding: '4px 12px',
                      borderRadius: '12px',
                      boxShadow: '0 2px 8px rgba(16, 185, 129, 0.3)'
                    }
                  }, stepConfig.badge),
                  
                  h('div', { 
                    style: { 
                      fontSize: '2rem',
                      marginBottom: '0.5rem'
                    } 
                  }, option.icon),
                  
                  h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                    h('div', { 
                      style: { 
                        fontWeight: '500', 
                        color: '#1F2937',
                        fontSize: '1rem'
                      } 
                    }, option.title),
                    h('div', {
                      style: { 
                        fontWeight: 'bold',
                        color: isHighlighted ? '#10B981' : '#EF4444',
                        fontSize: '1.125rem'
                      }
                    }, '→')
                  )
                );
              })
            ),

            h('div', { 
              style: { 
                textAlign: 'center', 
                fontSize: '0.875rem', 
                color: '#6B7280' 
              } 
            }, "100% free • No obligation")
          ),

          // Step 2: Value - High Complexity
          currentStep === 'value' && getValueStep() === 'value-high' && h('div', { 
            style: { display: 'flex', flexDirection: 'column', gap: '1.5rem' } 
          },
            // Back Button
            h('button', {
              onClick: () => goToStep('qualification'),
              style: {
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem',
                color: '#EF4444',
                background: 'transparent',
                border: 'none',
                cursor: 'pointer',
                padding: '0.5rem 1rem',
                borderRadius: '0.5rem',
                fontSize: '0.875rem',
                fontWeight: '500'
              },
              onMouseEnter: (e) => { e.target.style.background = '#FEF2F2'; },
              onMouseLeave: (e) => { e.target.style.background = 'transparent'; }
            }, h(ArrowLeftIcon), 'Back'),

            // Headline
            h('h2', { 
              style: { 
                fontSize: '1.5rem', 
                fontWeight: '600', 
                color: '#1F2937', 
                marginBottom: '1rem' 
              } 
            }, `Perfect! Here's what you need to know about ${userData.situation?.replace(/-/g, ' ')}...`),

            // Warning Box
            h('div', {
              style: {
                background: '#FEF3C7',
                border: '2px solid #FDE68A',
                borderRadius: '0.75rem',
                padding: '1.25rem',
                marginBottom: '1.5rem'
              }
            },
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.75rem' } },
                h('span', { style: { fontSize: '1.5rem' } }, '⚠️'),
                h('h3', { 
                  style: { 
                    fontSize: '1rem', 
                    fontWeight: 'bold', 
                    color: '#B45309' 
                  } 
                }, 'IMPORTANT TO KNOW')
              ),
              h('p', { 
                style: { 
                  fontSize: '0.875rem', 
                  color: '#92400E', 
                  lineHeight: '1.5' 
                } 
              }, 'Most people in your situation miss key savings because they don\'t know about these hidden factors:')
            ),

            // Insights List
            h('div', { style: { marginBottom: '1.5rem' } },
              ...getSituationInsights(userData.situation).map((insight, idx) =>
                h('div', {
                  key: idx,
                  style: {
                    display: 'flex',
                    alignItems: 'flex-start',
                    gap: '0.75rem',
                    marginBottom: '1rem'
                  }
                },
                  h('div', {
                    style: {
                      width: '24px',
                      height: '24px',
                      borderRadius: '50%',
                      background: '#D1FAE5',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }
                  }, h(CheckIcon, { style: { color: '#10B981', width: '16px', height: '16px' } })),
                  h('div', {},
                    h('div', { 
                      style: { 
                        fontWeight: '500', 
                        color: '#1F2937', 
                        fontSize: '1rem',
                        marginBottom: '0.25rem' 
                      } 
                    }, insight.title),
                    h('div', { 
                      style: { 
                        fontSize: '0.875rem', 
                        color: '#6B7280', 
                        lineHeight: '1.5' 
                      } 
                    }, insight.desc)
                  )
                )
              )
            ),

            // Savings Box
            h('div', {
              style: {
                background: '#DBEAFE',
                border: '2px solid #BFDBFE',
                borderRadius: '0.75rem',
                padding: '1.25rem',
                marginBottom: '1.5rem'
              }
            },
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.5rem' } },
                h('span', { style: { fontSize: '1.5rem' } }, '💡'),
                h('h3', { 
                  style: { 
                    fontSize: '1rem', 
                    fontWeight: 'bold', 
                    color: '#1E40AF' 
                  } 
                }, 'Typical Savings')
              ),
              h('p', { 
                style: { 
                  fontSize: '0.875rem', 
                  color: '#1E3A8A', 
                  lineHeight: '1.5' 
                } 
              }, 'People in your situation typically save CHF 1,500-2,800 per year with expert guidance.')
            ),

            // Section Heading
            h('h3', { 
              style: { 
                fontSize: '1.25rem', 
                fontWeight: '600', 
                color: '#1F2937', 
                marginBottom: '1.5rem' 
              } 
            }, 'How would you like to proceed?'),

            // Primary Option (Consultation)
            h('div', {
              style: {
                position: 'relative',
                background: '#EF4444',
                borderRadius: '0.75rem',
                padding: '2rem',
                marginBottom: '1.25rem',
                boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)'
              }
            },
              // Recommended Badge
              h('div', {
                style: {
                  position: 'absolute',
                  top: '-12px',
                  left: '24px',
                  background: '#FFFFFF',
                  color: '#EF4444',
                  fontSize: '0.75rem',
                  fontWeight: 'bold',
                  textTransform: 'uppercase',
                  padding: '4px 12px',
                  borderRadius: '12px',
                  boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }
              }, '✓ RECOMMENDED'),
              
              // Header
              h('div', { style: { marginBottom: '1rem' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem' } },
                  h('span', { style: { fontSize: '2rem' } }, '📞'),
                  h('h4', { 
                    style: { 
                      fontSize: '1.5rem', 
                      fontWeight: 'bold', 
                      color: '#FFFFFF' 
                    } 
                  }, '15-Min Expert Call')
                )
              ),
              
              // Benefits
              h('div', { style: { marginBottom: '1.5rem' } },
                ['Personalized strategies', 'Hidden discounts included', '2026 timeline planning'].map((benefit, idx) =>
                  h('div', {
                    key: idx,
                    style: {
                      color: '#FFFFFF',
                      fontSize: '0.875rem',
                      marginBottom: '0.5rem',
                      opacity: '0.95'
                    }
                  }, `• ${benefit}`)
                )
              ),
              
              // CTA Button
              h('button', {
                onClick: () => goToStep('booking-info'),
                style: {
                  width: '100%',
                  height: '48px',
                  background: '#FFFFFF',
                  color: '#EF4444',
                  fontSize: '1rem',
                  fontWeight: '600',
                  border: 'none',
                  borderRadius: '0.5rem',
                  cursor: 'pointer',
                  boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                  transition: 'all 0.2s'
                },
                onMouseEnter: (e) => { 
                  e.target.style.background = '#F9FAFB'; 
                  e.target.style.transform = 'translateY(-1px)';
                  e.target.style.boxShadow = '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)';
                },
                onMouseLeave: (e) => { 
                  e.target.style.background = '#FFFFFF'; 
                  e.target.style.transform = 'translateY(0)';
                  e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                }
              }, 'BOOK FREE CALL →')
            ),

            // Divider
            h('div', {
              style: {
                display: 'flex',
                alignItems: 'center',
                margin: '1.25rem 0',
                fontSize: '0.875rem',
                color: '#9CA3AF'
              }
            },
              h('div', { style: { flex: 1, height: '1px', background: '#E5E7EB' } }),
              h('span', { style: { padding: '0 1rem' } }, 'or'),
              h('div', { style: { flex: 1, height: '1px', background: '#E5E7EB' } })
            ),

            // Secondary Option
            h('div', { style: { textAlign: 'center' } },
              h('button', {
                onClick: () => goToStep('form'),
                style: {
                  width: '100%',
                  height: '48px',
                  background: 'transparent',
                  color: '#6B7280',
                  fontSize: '0.875rem',
                  fontWeight: '500',
                  border: '2px solid #E5E7EB',
                  borderRadius: '0.5rem',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                },
                onMouseEnter: (e) => { 
                  e.target.style.background = '#F9FAFB'; 
                  e.target.style.borderColor = '#D1D5DB';
                  e.target.style.color = '#1F2937';
                },
                onMouseLeave: (e) => { 
                  e.target.style.background = 'transparent'; 
                  e.target.style.borderColor = '#E5E7EB';
                  e.target.style.color = '#6B7280';
                }
              }, 'Get Standard Quotes (4-5 min)'),
              h('div', {
                style: {
                  fontSize: '0.75rem',
                  color: '#F59E0B',
                  textAlign: 'center',
                  marginTop: '0.5rem',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '0.25rem'
                }
              }, h('span', {}, '⚠️'), 'May miss CHF 1,200 in savings')
            )
          ),

          // Step 3: Booking Info
          currentStep === 'booking-info' && h('div', { 
            style: { display: 'flex', flexDirection: 'column', gap: '1.5rem' } 
          },
            // Back Button
            h('button', {
              onClick: () => goToStep('value'),
              style: {
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem',
                color: '#EF4444',
                background: 'transparent',
                border: 'none',
                cursor: 'pointer',
                padding: '0.5rem 1rem',
                borderRadius: '0.5rem',
                fontSize: '0.875rem',
                fontWeight: '500'
              },
              onMouseEnter: (e) => { e.target.style.background = '#FEF2F2'; },
              onMouseLeave: (e) => { e.target.style.background = 'transparent'; }
            }, h(ArrowLeftIcon), 'Back'),

            // Header
            h('div', { style: { textAlign: 'center' } },
              h('h2', { 
                style: { 
                  fontSize: '1.5rem', 
                  fontWeight: '600', 
                  color: '#1F2937', 
                  marginBottom: '1rem' 
                } 
              }, 'Perfect! Let\'s get you booked 🎉'),
              h('p', { 
                style: { 
                  fontSize: '1rem', 
                  color: '#6B7280', 
                  lineHeight: '1.5',
                  marginBottom: '1.5rem' 
                } 
              }, `This will be a 15-minute call where we'll review your ${userData.situation?.replace(/-/g, ' ')} and find you the best rates + discounts.`)
            ),

            // Expectation Box
            h('div', {
              style: {
                background: '#F9FAFB',
                border: '1px solid #E5E7EB',
                borderRadius: '0.75rem',
                padding: '1.25rem',
                marginBottom: '2rem'
              }
            },
              h('h3', { 
                style: { 
                  fontSize: '1rem', 
                  fontWeight: '600', 
                  color: '#1F2937', 
                  marginBottom: '0.75rem' 
                } 
              }, 'What you\'ll get:'),
              h('div', {},
                ['Personalized recommendations', 'Hidden discount opportunities', '2026 switching strategy'].map((benefit, idx) =>
                  h('div', {
                    key: idx,
                    style: {
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.75rem',
                      marginBottom: '0.625rem'
                    }
                  },
                    h(CheckIcon, { style: { color: '#10B981', width: '18px', height: '18px' } }),
                    h('span', { 
                      style: { 
                        fontSize: '0.875rem', 
                        color: '#1F2937' 
                      } 
                    }, benefit)
                  )
                )
              )
            ),

            // Form Section
            h('div', {},
              h('h3', { 
                style: { 
                  fontSize: '1rem', 
                  fontWeight: '500', 
                  color: '#1F2937', 
                  marginBottom: '1.25rem' 
                } 
              }, 'Quick info for the booking:'),
              
              h('form', {
                onSubmit: handleBookingSubmit,
                style: { 
                  maxWidth: '28rem', 
                  margin: '0 auto', 
                  display: 'flex', 
                  flexDirection: 'column', 
                  gap: '1.25rem' 
                }
              },
                // Name Field
                h('div', {},
                  h('label', {
                    style: { 
                      display: 'block', 
                      fontSize: '0.875rem', 
                      fontWeight: '500', 
                      color: '#1F2937', 
                      marginBottom: '0.375rem' 
                    }
                  }, 'Your Name'),
                  h('input', {
                    type: 'text',
                    value: formData.name,
                    onChange: (e) => setFormData(prev => ({ ...prev, name: e.target.value })),
                    required: true,
                    style: {
                      width: '100%',
                      height: '48px',
                      padding: '0.75rem 1rem',
                      fontSize: '1rem',
                      color: '#1F2937',
                      background: '#FFFFFF',
                      border: '2px solid #E5E7EB',
                      borderRadius: '0.5rem',
                      transition: 'border-color 0.2s, box-shadow 0.2s'
                    },
                    placeholder: 'John Doe',
                    onFocus: (e) => {
                      e.target.style.borderColor = '#EF4444';
                      e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                    },
                    onBlur: (e) => {
                      e.target.style.borderColor = '#E5E7EB';
                      e.target.style.boxShadow = 'none';
                    }
                  })
                ),

                // Email Field
                h('div', {},
                  h('label', {
                    style: { 
                      display: 'block', 
                      fontSize: '0.875rem', 
                      fontWeight: '500', 
                      color: '#1F2937', 
                      marginBottom: '0.375rem' 
                    }
                  }, 'Email Address'),
                  h('input', {
                    type: 'email',
                    value: formData.email,
                    onChange: (e) => setFormData(prev => ({ ...prev, email: e.target.value })),
                    required: true,
                    style: {
                      width: '100%',
                      height: '48px',
                      padding: '0.75rem 1rem',
                      fontSize: '1rem',
                      color: '#1F2937',
                      background: '#FFFFFF',
                      border: '2px solid #E5E7EB',
                      borderRadius: '0.5rem',
                      transition: 'border-color 0.2s, box-shadow 0.2s'
                    },
                    placeholder: 'john@example.com',
                    onFocus: (e) => {
                      e.target.style.borderColor = '#EF4444';
                      e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                    },
                    onBlur: (e) => {
                      e.target.style.borderColor = '#E5E7EB';
                      e.target.style.boxShadow = 'none';
                    }
                  })
                ),

                // Phone Field
                h('div', {},
                  h('label', {
                    style: { 
                      display: 'block', 
                      fontSize: '0.875rem', 
                      fontWeight: '500', 
                      color: '#1F2937', 
                      marginBottom: '0.375rem' 
                    }
                  }, 'Phone Number'),
                  h('div', { 
                    style: { 
                      fontSize: '0.75rem', 
                      color: '#6B7280', 
                      marginBottom: '0.375rem' 
                    } 
                  }, '(for appointment reminder)'),
                  h('input', {
                    type: 'tel',
                    value: formData.phone,
                    onChange: (e) => setFormData(prev => ({ ...prev, phone: e.target.value })),
                    required: true,
                    style: {
                      width: '100%',
                      height: '48px',
                      padding: '0.75rem 1rem',
                      fontSize: '1rem',
                      color: '#1F2937',
                      background: '#FFFFFF',
                      border: '2px solid #E5E7EB',
                      borderRadius: '0.5rem',
                      transition: 'border-color 0.2s, box-shadow 0.2s'
                    },
                    placeholder: '+41 79 123 4567',
                    onFocus: (e) => {
                      e.target.style.borderColor = '#EF4444';
                      e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                    },
                    onBlur: (e) => {
                      e.target.style.borderColor = '#E5E7EB';
                      e.target.style.boxShadow = 'none';
                    }
                  })
                ),
                
                // Submit Button
                h('button', {
                  type: 'submit',
                  style: {
                    width: '100%',
                    height: '56px',
                    background: '#EF4444',
                    color: '#FFFFFF',
                    fontSize: '1rem',
                    fontWeight: '600',
                    border: 'none',
                    borderRadius: '0.5rem',
                    cursor: 'pointer',
                    boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
                    margin: '2rem 0 1.5rem 0',
                    transition: 'all 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '0.5rem'
                  },
                  onMouseEnter: (e) => { 
                    e.target.style.background = '#DC2626'; 
                    e.target.style.transform = 'translateY(-2px)';
                    e.target.style.boxShadow = '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)';
                  },
                  onMouseLeave: (e) => { 
                    e.target.style.background = '#EF4444'; 
                    e.target.style.transform = 'translateY(0)';
                    e.target.style.boxShadow = '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)';
                  }
                }, 'CONTINUE TO CALENDAR', h(ArrowRightIcon))
              )
            ),

            // Trust Badges
            h('div', {
              style: {
                textAlign: 'center',
                fontSize: '0.875rem',
                color: '#6B7280',
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                gap: '1rem',
                flexWrap: 'wrap'
              }
            },
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '0.5rem' } },
                h(CheckIcon, { style: { color: '#10B981', width: '16px', height: '16px' } }),
                'Free & no obligation'
              ),
              h('div', { style: { display: 'flex', alignItems: 'center', gap: '0.5rem' } },
                h(CheckIcon, { style: { color: '#10B981', width: '16px', height: '16px' } }),
                'Easy to reschedule'
              )
            )
          ),

          // Step 4: Success
          currentStep === 'success' && h('div', { 
            style: { textAlign: 'center', maxWidth: '42rem', margin: '0 auto', padding: '2rem 0' } 
          },
            // Success Icon
            h('div', {
              style: {
                width: '80px',
                height: '80px',
                borderRadius: '50%',
                background: 'linear-gradient(135deg, #10B981 0%, #059669 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: '0 auto 1.5rem auto',
                boxShadow: '0 4px 6px rgba(16, 185, 129, 0.2)'
              }
            }, h(CheckIcon, { style: { color: '#FFFFFF', width: '40px', height: '40px' } })),
            
            h('h2', { 
              style: { 
                fontSize: '2rem', 
                fontWeight: 'bold', 
                color: '#1F2937', 
                marginBottom: '1rem' 
              } 
            }, 'Booking Confirmed! 🎉'),
            
            h('p', { 
              style: { 
                fontSize: '1.125rem', 
                color: '#374151', 
                lineHeight: '1.6',
                marginBottom: '2rem' 
              } 
            }, 'Your booking request has been submitted. We\'ll contact you shortly to schedule your free consultation.'),

            // Booking Details Box
            h('div', {
              style: {
                background: '#F9FAFB',
                border: '2px solid #E5E7EB',
                borderRadius: '0.75rem',
                padding: '1.5rem',
                marginBottom: '2rem',
                textAlign: 'center'
              }
            },
              h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem', marginBottom: '0.75rem' } },
                h('span', { style: { fontSize: '1.25rem' } }, '📅'),
                h('span', { style: { fontSize: '1rem', color: '#1F2937' } }, 'Next available: Today or Tomorrow')
              ),
              h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem', marginBottom: '0.75rem' } },
                h('span', { style: { fontSize: '1.25rem' } }, '⏱️'),
                h('span', { style: { fontSize: '1rem', color: '#1F2937' } }, '15 minutes')
              ),
              h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' } },
                h('span', { style: { fontSize: '1.25rem' } }, '📞'),
                h('span', { style: { fontSize: '1rem', color: '#EF4444', fontWeight: '500' } }, 'Video call link via email')
              )
            ),

            // What's Next Section
            h('div', { style: { textAlign: 'left', marginBottom: '2rem' } },
              h('h3', { 
                style: { 
                  fontSize: '1.25rem', 
                  fontWeight: '600', 
                  color: '#1F2937', 
                  marginBottom: '1.25rem' 
                } 
              }, 'What\'s Next:'),
              
              h('div', { style: { display: 'flex', flexDirection: 'column', gap: '1.25rem' } },
                ...['Check your email for calendar invite and call link', '(Optional) Reply with quick info: employment status, coverage needed, start date', 'Join the call - Robert will guide you through everything!'].map((step, idx) =>
                  h('div', {
                    key: idx,
                    style: {
                      display: 'flex',
                      alignItems: 'flex-start',
                      gap: '1rem'
                    }
                  },
                    h('div', {
                      style: {
                        width: '32px',
                        height: '32px',
                        borderRadius: '50%',
                        background: '#FEF2F2',
                        color: '#EF4444',
                        fontSize: '1.125rem',
                        fontWeight: 'bold',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: 0
                      }
                    }, idx + 1),
                    h('div', {
                      style: {
                        fontSize: '0.9375rem',
                        color: '#1F2937',
                        lineHeight: '1.6',
                        paddingTop: '0.25rem'
                      }
                    }, step)
                  )
                )
              )
            ),

            // Action Buttons
            h('div', {
              style: {
                display: 'flex',
                justifyContent: 'center',
                gap: '1rem',
                marginBottom: '1.5rem',
                flexWrap: 'wrap'
              }
            },
              h('button', {
                onClick: () => {
                  // Add to calendar functionality would go here
                  alert('Calendar integration would open here');
                },
                style: {
                  minWidth: '200px',
                  height: '48px',
                  background: '#EF4444',
                  color: '#FFFFFF',
                  fontSize: '0.9375rem',
                  fontWeight: '600',
                  border: 'none',
                  borderRadius: '0.5rem',
                  cursor: 'pointer',
                  boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)',
                  transition: 'all 0.2s'
                },
                onMouseEnter: (e) => { 
                  e.target.style.background = '#DC2626'; 
                  e.target.style.boxShadow = '0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1)';
                },
                onMouseLeave: (e) => { 
                  e.target.style.background = '#EF4444'; 
                  e.target.style.boxShadow = '0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1)';
                }
              }, 'ADD TO CALENDAR'),
              
              h('button', {
                onClick: onClose,
                style: {
                  minWidth: '120px',
                  height: '48px',
                  background: 'transparent',
                  color: '#6B7280',
                  fontSize: '0.9375rem',
                  fontWeight: '600',
                  border: '2px solid #E5E7EB',
                  borderRadius: '0.5rem',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                },
                onMouseEnter: (e) => { 
                  e.target.style.background = '#F9FAFB'; 
                  e.target.style.borderColor = '#D1D5DB';
                },
                onMouseLeave: (e) => { 
                  e.target.style.background = 'transparent'; 
                  e.target.style.borderColor = '#E5E7EB';
                }
              }, 'CLOSE')
            ),

            // Personal Signature
            h('div', {
              style: {
                fontSize: '1rem',
                color: '#6B7280',
                fontStyle: 'italic',
                textAlign: 'center',
                lineHeight: '1.5'
              }
            }, 'Looking forward to helping you save money! - Robert')
          )
        )
      )
    );
  };

  // Page context from Astro
  const pageContext = {
    intent: '${pageIntent}',
    city: '${city}',
    providerName: '${providerName}'
  };

  // Modal state
  let isModalOpen = false;
  let root = null;

  const renderModal = () => {
    const container = document.getElementById('professional-modal-container');
    if (!container) {
      console.error('❌ Modal container not found');
      return;
    }
    
    if (!root) {
      root = ReactDOM.createRoot(container);
    }
    
    root.render(h(SmartModal, {
      isOpen: isModalOpen,
      onClose: closeModal,
      pageContext: pageContext
    }));
  };
  
  const openModal = () => {
    console.log('🎯 Opening Professional Smart Modal');
    isModalOpen = true;
    renderModal();
  };
  
  const closeModal = () => {
    console.log('🔒 Closing Professional Smart Modal');
    isModalOpen = false;
    renderModal();
  };
  
  // Global functions for compatibility
  window.openSmartModal = openModal;
  window.closeSmartModal = closeModal;
  
  // Legacy compatibility
  window.openOffersModal = openModal;
  window.openConsultationModal = openModal;
  window.showConsultationModal = openModal;
  
  console.log('✅ Professional Smart Modal ready');
  console.log('📍 Page context:', pageContext);
  
  // Test the modal
  console.log('🧪 Testing modal functions...');
  console.log('openSmartModal available:', typeof window.openSmartModal === 'function');
  console.log('openOffersModal available:', typeof window.openOffersModal === 'function');
}

// Start initialization
initProfessionalModal();
</script>

<style>
  /* Responsive adjustments */
  @media (max-width: 1024px) {
    #professional-modal-container [style*="maxWidth: '1200px'"] {
      max-width: 90vw !important;
      max-height: 90vh !important;
      border-radius: 0.75rem !important;
    }
  }

  @media (max-width: 768px) {
    #professional-modal-container [style*="maxWidth: '1200px'"] {
      max-width: 100vw !important;
      max-height: 100vh !important;
      border-radius: 0 !important;
    }
    
    #professional-modal-container [style*="padding: '3rem'"] {
      padding: 1.25rem !important;
    }
  }

  /* Smooth animations */
  @keyframes modalEnter {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes modalExit {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0.95);
    }
  }

  /* Apply animations to modal container */
  #professional-modal-container > div > div:first-child > div:last-child {
    animation: modalEnter 0.2s ease-out;
  }
</style>